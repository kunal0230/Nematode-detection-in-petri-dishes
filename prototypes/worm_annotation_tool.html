<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worm Annotation Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0f1117;
            color: #e2e8f0;
            height: 100vh;
            overflow: hidden;
        }

        /* --- TOP BAR --- */
        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #1a1d2e;
            border-bottom: 1px solid #2d3148;
            padding: 8px 20px;
            height: 50px;
        }

        .top-bar .title {
            font-weight: 700;
            font-size: 16px;
            color: #a78bfa;
        }

        .top-bar .image-nav {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn {
            background: #2d3148;
            border: 1px solid #3d4260;
            color: #e2e8f0;
            padding: 6px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: background 0.2s;
        }

        .nav-btn:hover {
            background: #3d4260;
        }

        .nav-btn:disabled {
            opacity: 0.4;
            cursor: default;
        }

        .image-counter {
            font-size: 13px;
            color: #94a3b8;
            min-width: 100px;
            text-align: center;
        }

        .top-bar .actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 16px;
            border-radius: 6px;
            border: none;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn.primary {
            background: #a78bfa;
            color: #1a1d2e;
        }

        .action-btn.primary:hover {
            background: #8b5cf6;
        }

        .action-btn.secondary {
            background: #2d3148;
            color: #e2e8f0;
            border: 1px solid #3d4260;
        }

        .action-btn.secondary:hover {
            background: #3d4260;
        }

        .action-btn.export {
            background: #10b981;
            color: white;
        }

        .action-btn.export:hover {
            background: #059669;
        }

        /* --- MAIN LAYOUT --- */
        .main-layout {
            display: flex;
            height: calc(100vh - 50px);
        }

        /* --- LEFT: IMAGE STRIP --- */
        .image-strip {
            width: 140px;
            background: #13151f;
            border-right: 1px solid #2d3148;
            overflow-y: auto;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .image-strip::-webkit-scrollbar {
            width: 4px;
        }

        .image-strip::-webkit-scrollbar-thumb {
            background: #3d4260;
            border-radius: 4px;
        }

        .thumb-item {
            position: relative;
            border-radius: 6px;
            overflow: hidden;
            border: 2px solid transparent;
            cursor: pointer;
            transition: border-color 0.2s;
            flex-shrink: 0;
        }

        .thumb-item.active {
            border-color: #a78bfa;
        }

        .thumb-item:hover {
            border-color: #6366f1;
        }

        .thumb-item img {
            width: 100%;
            height: 80px;
            object-fit: cover;
            display: block;
        }

        .thumb-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: #e2e8f0;
            font-size: 10px;
            padding: 2px 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .thumb-badge {
            position: absolute;
            top: 3px;
            right: 3px;
            background: #a78bfa;
            color: white;
            font-size: 9px;
            font-weight: 700;
            padding: 1px 5px;
            border-radius: 8px;
        }

        .drop-zone {
            border: 2px dashed #3d4260;
            border-radius: 8px;
            padding: 20px 10px;
            text-align: center;
            cursor: pointer;
            color: #64748b;
            font-size: 12px;
            transition: border-color 0.2s;
        }

        .drop-zone:hover,
        .drop-zone.dragover {
            border-color: #a78bfa;
            color: #a78bfa;
        }

        /* --- CENTER: CANVAS --- */
        .canvas-area {
            flex: 1;
            background: #0f1117;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .canvas-wrapper {
            overflow: auto;
            max-width: 100%;
            max-height: 100%;
        }

        #annotationCanvas {
            display: block;
            cursor: crosshair;
            border-radius: 4px;
        }

        #annotationCanvas.panning {
            cursor: grab;
        }

        #annotationCanvas.panning-active {
            cursor: grabbing;
        }

        .pan-indicator {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(167, 139, 250, 0.85);
            color: white;
            padding: 4px 14px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            pointer-events: none;
            display: none;
            z-index: 10;
        }

        .canvas-hint {
            color: #475569;
            font-size: 14px;
            text-align: center;
        }

        .canvas-hint span {
            font-size: 40px;
            display: block;
            margin-bottom: 10px;
        }

        /* --- RIGHT: PANEL --- */
        .right-panel {
            width: 260px;
            background: #1a1d2e;
            border-left: 1px solid #2d3148;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .panel-section {
            padding: 12px 14px;
            border-bottom: 1px solid #2d3148;
        }

        .panel-section h4 {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #64748b;
            margin-bottom: 10px;
        }

        /* Tools */
        .tools-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }

        .tool-btn {
            padding: 8px;
            background: #2d3148;
            border: 1px solid #3d4260;
            border-radius: 6px;
            color: #e2e8f0;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .tool-btn:hover {
            background: #3d4260;
        }

        .tool-btn.active {
            background: #a78bfa;
            color: #1a1d2e;
            border-color: #a78bfa;
        }

        /* Zoom */
        .zoom-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .zoom-row button {
            background: #2d3148;
            border: 1px solid #3d4260;
            color: #e2e8f0;
            width: 28px;
            height: 28px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }

        .zoom-row button:hover {
            background: #3d4260;
        }

        .zoom-row span {
            font-size: 12px;
            color: #94a3b8;
            min-width: 40px;
            text-align: center;
        }

        /* Stats */
        .stat-row {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            padding: 3px 0;
        }

        .stat-row .label {
            color: #94a3b8;
        }

        .stat-row .value {
            color: #a78bfa;
            font-weight: 700;
        }

        /* Annotation List */
        .ann-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px 14px;
        }

        .ann-list::-webkit-scrollbar {
            width: 4px;
        }

        .ann-list::-webkit-scrollbar-thumb {
            background: #3d4260;
            border-radius: 4px;
        }

        .ann-item {
            background: #2d3148;
            border-radius: 6px;
            padding: 8px 10px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
        }

        .ann-item .info {
            color: #94a3b8;
        }

        .ann-item .info strong {
            color: #e2e8f0;
        }

        .ann-item .del-btn {
            background: none;
            border: none;
            color: #f87171;
            cursor: pointer;
            font-size: 14px;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .ann-item .del-btn:hover {
            background: rgba(248, 113, 113, 0.15);
        }

        /* Keyboard shortcuts */
        .shortcuts {
            font-size: 11px;
            color: #64748b;
        }

        .shortcuts div {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
        }

        .shortcuts kbd {
            background: #2d3148;
            padding: 1px 5px;
            border-radius: 3px;
            font-family: monospace;
            color: #94a3b8;
        }
    </style>
</head>

<body>

    <!-- TOP BAR -->
    <div class="top-bar">
        <div class="title">Worm Annotation Tool</div>
        <div class="image-nav">
            <button class="nav-btn" id="prevBtn" onclick="navigateImage(-1)" disabled>&larr; Prev</button>
            <span class="image-counter" id="imageCounter">No images loaded</span>
            <button class="nav-btn" id="nextBtn" onclick="navigateImage(1)" disabled>Next &rarr;</button>
        </div>
        <div class="actions">
            <button class="action-btn secondary" onclick="undoLast()">Undo</button>
            <button class="action-btn secondary" onclick="clearCurrent()">Clear</button>
            <button class="action-btn export" onclick="exportAllYOLO()">Export All (YOLO)</button>
            <button class="action-btn export" onclick="exportAllCOCO()">Export All (COCO)</button>
        </div>
    </div>

    <!-- MAIN LAYOUT -->
    <div class="main-layout">
        <!-- LEFT: Thumbnails -->
        <div class="image-strip" id="imageStrip">
            <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
                <div>Click or<br>Drop Images</div>
            </div>
            <input type="file" id="fileInput" multiple accept="image/*" style="display:none">
        </div>

        <!-- CENTER: Canvas -->
        <div class="canvas-area" id="canvasArea">
            <div class="pan-indicator" id="panIndicator">PAN MODE (hold Space)</div>
            <div class="canvas-hint" id="canvasHint">
                <span>&#128248;</span>
                Load images from the left panel to start annotating
            </div>
            <div class="canvas-wrapper" id="canvasWrapper" style="display:none">
                <canvas id="annotationCanvas"></canvas>
            </div>
        </div>

        <!-- RIGHT: Panel -->
        <div class="right-panel">
            <div class="panel-section">
                <h4>Tools</h4>
                <div class="tools-grid">
                    <button class="tool-btn active" id="tool-box" onclick="selectTool('box')">Box</button>
                    <button class="tool-btn" id="tool-polygon" onclick="selectTool('polygon')">Polygon</button>
                    <button class="tool-btn" id="tool-point" onclick="selectTool('point')">Point</button>
                </div>
            </div>

            <div class="panel-section">
                <h4>Zoom</h4>
                <div class="zoom-row">
                    <button onclick="adjustZoom(-0.1)">&minus;</button>
                    <span id="zoomLevel">100%</span>
                    <button onclick="adjustZoom(0.1)">+</button>
                    <button onclick="resetZoom()" style="width:auto; padding:0 8px; font-size:11px;">Fit</button>
                </div>
            </div>

            <div class="panel-section">
                <h4>Current Image Stats</h4>
                <div class="stat-row"><span class="label">File</span><span class="value" id="statFile">-</span></div>
                <div class="stat-row"><span class="label">Size</span><span class="value" id="statSize">-</span></div>
                <div class="stat-row"><span class="label">Annotations</span><span class="value" id="statAnns">0</span>
                </div>
                <div class="stat-row"><span class="label">Total (all images)</span><span class="value"
                        id="statTotal">0</span></div>
            </div>

            <div class="panel-section">
                <h4>Annotations</h4>
            </div>
            <div class="ann-list" id="annList"></div>

            <div class="panel-section">
                <h4>Shortcuts</h4>
                <div class="shortcuts">
                    <div><span>Prev / Next</span><kbd>&larr;</kbd> <kbd>&rarr;</kbd></div>
                    <div><span>Undo</span><kbd>Ctrl+Z</kbd></div>
                    <div><span>Box tool</span><kbd>B</kbd></div>
                    <div><span>Polygon tool</span><kbd>P</kbd></div>
                    <div><span>Point tool</span><kbd>T</kbd></div>
                    <div><span>Pan (drag)</span><kbd>Space</kbd></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===========================================================================
        // STATE
        // ===========================================================================
        let images = [];           // [{file, name, img, width, height, dataURL}]
        let allAnnotations = {};   // { imageName: [annotations] }
        let currentIndex = -1;
        let currentTool = 'box';
        let isDrawing = false;
        let startX = 0, startY = 0;
        let currentAnnotation = null;
        let polygonPoints = [];
        let currentZoom = 1.0;

        const canvas = document.getElementById('annotationCanvas');
        const ctx = canvas.getContext('2d');

        // ===========================================================================
        // IMAGE LOADING
        // ===========================================================================
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');

        fileInput.addEventListener('change', e => loadFiles(e.target.files));

        dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', e => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            loadFiles(e.dataTransfer.files);
        });

        // Also allow dropping on the canvas area
        const canvasArea = document.getElementById('canvasArea');
        canvasArea.addEventListener('dragover', e => e.preventDefault());
        canvasArea.addEventListener('drop', e => {
            e.preventDefault();
            loadFiles(e.dataTransfer.files);
        });

        function loadFiles(fileList) {
            const imageFiles = Array.from(fileList).filter(f => f.type.startsWith('image/'));
            if (imageFiles.length === 0) return;

            // Sort by name for consistent order
            imageFiles.sort((a, b) => a.name.localeCompare(b.name));

            let loaded = 0;
            imageFiles.forEach(file => {
                // Skip duplicates
                if (images.some(img => img.name === file.name)) return;

                const reader = new FileReader();
                reader.onload = function (evt) {
                    const img = new Image();
                    img.onload = function () {
                        const entry = {
                            file: file,
                            name: file.name,
                            img: img,
                            width: img.naturalWidth,
                            height: img.naturalHeight,
                            dataURL: evt.target.result
                        };
                        images.push(entry);
                        // Sort images array by name
                        images.sort((a, b) => a.name.localeCompare(b.name));

                        if (!allAnnotations[file.name]) {
                            allAnnotations[file.name] = [];
                        }

                        renderThumbnails();

                        // Auto-select first image if none selected
                        if (currentIndex === -1) {
                            selectImage(0);
                        } else {
                            // Re-find current index after sort
                            const idx = images.findIndex(im => im.name === images[currentIndex]?.name);
                            if (idx !== -1) currentIndex = idx;
                            updateNav();
                        }
                    };
                    img.src = evt.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function renderThumbnails() {
            const strip = document.getElementById('imageStrip');
            // Keep drop zone, clear the rest
            const thumbs = strip.querySelectorAll('.thumb-item');
            thumbs.forEach(t => t.remove());

            images.forEach((entry, idx) => {
                const div = document.createElement('div');
                div.className = 'thumb-item' + (idx === currentIndex ? ' active' : '');
                div.onclick = () => selectImage(idx);

                const img = document.createElement('img');
                img.src = entry.dataURL;
                div.appendChild(img);

                const label = document.createElement('div');
                label.className = 'thumb-label';
                label.textContent = entry.name;
                div.appendChild(label);

                const anns = allAnnotations[entry.name] || [];
                if (anns.length > 0) {
                    const badge = document.createElement('div');
                    badge.className = 'thumb-badge';
                    badge.textContent = anns.length;
                    div.appendChild(badge);
                }

                strip.appendChild(div);
            });
        }

        // ===========================================================================
        // NAVIGATION
        // ===========================================================================
        function selectImage(idx) {
            if (idx < 0 || idx >= images.length) return;

            // Save current polygon-in-progress if any
            polygonPoints = [];

            currentIndex = idx;
            const entry = images[idx];

            // Set canvas to FULL original resolution
            canvas.width = entry.width;
            canvas.height = entry.height;

            document.getElementById('canvasHint').style.display = 'none';
            document.getElementById('canvasWrapper').style.display = 'block';

            // Fit zoom
            fitZoom();
            redrawCanvas();
            updateUI();
            renderThumbnails();
        }

        function navigateImage(direction) {
            const newIdx = currentIndex + direction;
            if (newIdx >= 0 && newIdx < images.length) {
                selectImage(newIdx);
            }
        }

        function updateNav() {
            document.getElementById('prevBtn').disabled = currentIndex <= 0;
            document.getElementById('nextBtn').disabled = currentIndex >= images.length - 1;
            if (images.length > 0 && currentIndex >= 0) {
                document.getElementById('imageCounter').textContent =
                    `${currentIndex + 1} / ${images.length}`;
            } else {
                document.getElementById('imageCounter').textContent = 'No images loaded';
            }
        }

        // ===========================================================================
        // ZOOM
        // ===========================================================================
        function adjustZoom(delta) {
            setZoom(currentZoom + delta);
        }

        function setZoom(zoom) {
            currentZoom = Math.min(Math.max(0.1, zoom), 5.0);
            document.getElementById('zoomLevel').textContent = Math.round(currentZoom * 100) + '%';
            canvas.style.width = (canvas.width * currentZoom) + 'px';
            canvas.style.height = (canvas.height * currentZoom) + 'px';
        }

        function resetZoom() {
            setZoom(1.0);
        }

        function fitZoom() {
            if (currentIndex < 0) return;
            const area = document.getElementById('canvasArea');
            const w = area.clientWidth - 40;
            const h = area.clientHeight - 40;
            const entry = images[currentIndex];
            const scale = Math.min(w / entry.width, h / entry.height, 1.0);
            setZoom(scale);
        }

        // ===========================================================================
        // TOOLS
        // ===========================================================================
        function selectTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tool-' + tool).classList.add('active');
            if (tool !== 'polygon') polygonPoints = [];
            redrawCanvas();
        }

        // ===========================================================================
        // DRAWING
        // ===========================================================================
        function getCanvasCoords(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return {
                x: (e.clientX - rect.left) * scaleX,
                y: (e.clientY - rect.top) * scaleY
            };
        }

        canvas.addEventListener('mousedown', e => {
            if (currentIndex < 0) return;
            if (isPanMode || isPanning) return; // Don't draw while panning
            if (e.button !== 0) return; // Only left-click for drawing
            const { x, y } = getCanvasCoords(e);

            if (currentTool === 'box') {
                isDrawing = true;
                startX = x; startY = y;
                currentAnnotation = { type: 'box', x, y, width: 0, height: 0, label: 'worm' };
            } else if (currentTool === 'polygon') {
                polygonPoints.push({ x, y });
                redrawCanvas();
            } else if (currentTool === 'point') {
                getAnnotations().push({ type: 'point', x, y, label: 'worm' });
                redrawCanvas();
                updateUI();
            }
        });

        canvas.addEventListener('mousemove', e => {
            if (!isDrawing || currentTool !== 'box') return;
            const { x, y } = getCanvasCoords(e);
            currentAnnotation.width = x - startX;
            currentAnnotation.height = y - startY;
            redrawCanvas();

            // Draw live preview box
            ctx.strokeStyle = '#a78bfa';
            ctx.lineWidth = 3;
            ctx.setLineDash([6, 4]);
            ctx.strokeRect(currentAnnotation.x, currentAnnotation.y,
                currentAnnotation.width, currentAnnotation.height);
            ctx.setLineDash([]);
        });

        canvas.addEventListener('mouseup', e => {
            if (currentTool === 'box' && isDrawing) {
                isDrawing = false;
                if (Math.abs(currentAnnotation.width) > 5 && Math.abs(currentAnnotation.height) > 5) {
                    // Normalize negative dimensions
                    if (currentAnnotation.width < 0) {
                        currentAnnotation.x += currentAnnotation.width;
                        currentAnnotation.width = Math.abs(currentAnnotation.width);
                    }
                    if (currentAnnotation.height < 0) {
                        currentAnnotation.y += currentAnnotation.height;
                        currentAnnotation.height = Math.abs(currentAnnotation.height);
                    }
                    getAnnotations().push(currentAnnotation);
                    updateUI();
                }
                currentAnnotation = null;
                redrawCanvas();
            }
        });

        canvas.addEventListener('dblclick', e => {
            if (currentTool === 'polygon' && polygonPoints.length >= 3) {
                getAnnotations().push({ type: 'polygon', points: [...polygonPoints], label: 'worm' });
                polygonPoints = [];
                redrawCanvas();
                updateUI();
            }
        });

        // ===========================================================================
        // GET / SET ANNOTATIONS FOR CURRENT IMAGE
        // ===========================================================================
        function getAnnotations() {
            if (currentIndex < 0) return [];
            const name = images[currentIndex].name;
            if (!allAnnotations[name]) allAnnotations[name] = [];
            return allAnnotations[name];
        }

        // ===========================================================================
        // DRAWING
        // ===========================================================================
        function redrawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (currentIndex >= 0) {
                const entry = images[currentIndex];
                ctx.drawImage(entry.img, 0, 0, canvas.width, canvas.height);
            }

            const anns = getAnnotations();
            const color = '#a78bfa';

            anns.forEach((ann, idx) => {
                ctx.lineWidth = 3;
                ctx.strokeStyle = color;

                if (ann.type === 'box') {
                    ctx.strokeRect(ann.x, ann.y, ann.width, ann.height);
                    ctx.fillStyle = 'rgba(167, 139, 250, 0.15)';
                    ctx.fillRect(ann.x, ann.y, ann.width, ann.height);

                    // Label
                    const label = `#${idx + 1}`;
                    ctx.font = 'bold 16px sans-serif';
                    const tw = ctx.measureText(label).width;
                    ctx.fillStyle = color;
                    ctx.fillRect(ann.x, ann.y - 22, tw + 8, 22);
                    ctx.fillStyle = '#1a1d2e';
                    ctx.fillText(label, ann.x + 4, ann.y - 6);
                } else if (ann.type === 'polygon') {
                    ctx.beginPath();
                    ctx.moveTo(ann.points[0].x, ann.points[0].y);
                    for (let i = 1; i < ann.points.length; i++) {
                        ctx.lineTo(ann.points[i].x, ann.points[i].y);
                    }
                    ctx.closePath();
                    ctx.stroke();
                    ctx.fillStyle = 'rgba(167, 139, 250, 0.15)';
                    ctx.fill();

                    ctx.font = 'bold 16px sans-serif';
                    ctx.fillStyle = color;
                    ctx.fillText(`#${idx + 1}`, ann.points[0].x, ann.points[0].y - 8);
                } else if (ann.type === 'point') {
                    ctx.beginPath();
                    ctx.arc(ann.x, ann.y, 6, 0, 2 * Math.PI);
                    ctx.fillStyle = color;
                    ctx.fill();
                    ctx.stroke();
                    ctx.font = 'bold 16px sans-serif';
                    ctx.fillText(`#${idx + 1}`, ann.x + 12, ann.y - 8);
                }
            });

            // Draw polygon in progress
            if (currentTool === 'polygon' && polygonPoints.length > 0) {
                ctx.strokeStyle = '#f59e0b';
                ctx.fillStyle = '#f59e0b';
                ctx.lineWidth = 2;

                polygonPoints.forEach(p => {
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 4, 0, 2 * Math.PI);
                    ctx.fill();
                });

                if (polygonPoints.length > 1) {
                    ctx.beginPath();
                    ctx.moveTo(polygonPoints[0].x, polygonPoints[0].y);
                    for (let i = 1; i < polygonPoints.length; i++) {
                        ctx.lineTo(polygonPoints[i].x, polygonPoints[i].y);
                    }
                    ctx.stroke();
                }
            }
        }

        // ===========================================================================
        // UI UPDATES
        // ===========================================================================
        function updateUI() {
            updateNav();
            updateStats();
            updateAnnList();
            renderThumbnails();
        }

        function updateStats() {
            if (currentIndex >= 0) {
                const entry = images[currentIndex];
                document.getElementById('statFile').textContent = entry.name;
                document.getElementById('statSize').textContent = `${entry.width} x ${entry.height}`;
                document.getElementById('statAnns').textContent = getAnnotations().length;
            }

            let total = 0;
            Object.values(allAnnotations).forEach(arr => total += arr.length);
            document.getElementById('statTotal').textContent = total;
        }

        function updateAnnList() {
            const list = document.getElementById('annList');
            list.innerHTML = '';
            const anns = getAnnotations();

            anns.forEach((ann, idx) => {
                const div = document.createElement('div');
                div.className = 'ann-item';

                let info = '';
                if (ann.type === 'box') {
                    info = `Box ${Math.round(ann.width)}x${Math.round(ann.height)}`;
                } else if (ann.type === 'polygon') {
                    info = `Polygon (${ann.points.length} pts)`;
                } else {
                    info = `Point`;
                }

                div.innerHTML = `
            <span class="info"><strong>#${idx + 1}</strong> ${info}</span>
            <button class="del-btn" onclick="deleteAnnotation(${idx})">✕</button>
        `;
                list.appendChild(div);
            });
        }

        function deleteAnnotation(idx) {
            getAnnotations().splice(idx, 1);
            redrawCanvas();
            updateUI();
        }

        function clearCurrent() {
            if (currentIndex < 0) return;
            if (!confirm('Clear all annotations on this image?')) return;
            allAnnotations[images[currentIndex].name] = [];
            polygonPoints = [];
            redrawCanvas();
            updateUI();
        }

        function undoLast() {
            const anns = getAnnotations();
            if (anns.length > 0) {
                anns.pop();
                redrawCanvas();
                updateUI();
            }
        }

        // ===========================================================================
        // EXPORT ALL (YOLO) — one .txt per image, zipped
        // ===========================================================================
        function exportAllYOLO() {
            if (images.length === 0) { alert('No images loaded'); return; }

            const annotatedImages = images.filter(img => (allAnnotations[img.name] || []).length > 0);
            if (annotatedImages.length === 0) { alert('No annotations to export'); return; }

            // Create a combined download: one file per image
            annotatedImages.forEach(entry => {
                const anns = allAnnotations[entry.name] || [];
                let yoloText = '';

                anns.forEach(ann => {
                    if (ann.type === 'box') {
                        const cx = (ann.x + ann.width / 2) / entry.width;
                        const cy = (ann.y + ann.height / 2) / entry.height;
                        const w = ann.width / entry.width;
                        const h = ann.height / entry.height;
                        yoloText += `0 ${cx.toFixed(6)} ${cy.toFixed(6)} ${w.toFixed(6)} ${h.toFixed(6)}\n`;
                    } else if (ann.type === 'polygon') {
                        // For polygons, compute bounding box
                        const xs = ann.points.map(p => p.x);
                        const ys = ann.points.map(p => p.y);
                        const minX = Math.min(...xs), maxX = Math.max(...xs);
                        const minY = Math.min(...ys), maxY = Math.max(...ys);
                        const cx = ((minX + maxX) / 2) / entry.width;
                        const cy = ((minY + maxY) / 2) / entry.height;
                        const w = (maxX - minX) / entry.width;
                        const h = (maxY - minY) / entry.height;
                        yoloText += `0 ${cx.toFixed(6)} ${cy.toFixed(6)} ${w.toFixed(6)} ${h.toFixed(6)}\n`;
                    }
                });

                if (yoloText) {
                    const baseName = entry.name.replace(/\.[^.]+$/, '');
                    downloadFile(yoloText, `${baseName}.txt`, 'text/plain');
                }
            });
        }

        // ===========================================================================
        // EXPORT ALL (COCO) — single JSON with all images
        // ===========================================================================
        function exportAllCOCO() {
            if (images.length === 0) { alert('No images loaded'); return; }

            const coco = {
                info: {
                    description: "Worm Detection Dataset",
                    version: "1.0",
                    date_created: new Date().toISOString()
                },
                images: [],
                annotations: [],
                categories: [{ id: 1, name: "worm", supercategory: "animal" }]
            };

            let annId = 1;

            images.forEach((entry, imgIdx) => {
                const imageId = imgIdx + 1;
                coco.images.push({
                    id: imageId,
                    width: entry.width,
                    height: entry.height,
                    file_name: entry.name
                });

                const anns = allAnnotations[entry.name] || [];
                anns.forEach(ann => {
                    const cocoAnn = {
                        id: annId++,
                        image_id: imageId,
                        category_id: 1,
                        iscrowd: 0
                    };

                    if (ann.type === 'box') {
                        cocoAnn.bbox = [ann.x, ann.y, ann.width, ann.height];
                        cocoAnn.area = ann.width * ann.height;
                        cocoAnn.segmentation = [[
                            ann.x, ann.y,
                            ann.x + ann.width, ann.y,
                            ann.x + ann.width, ann.y + ann.height,
                            ann.x, ann.y + ann.height
                        ]];
                    } else if (ann.type === 'polygon') {
                        const flatPoints = ann.points.flatMap(p => [p.x, p.y]);
                        cocoAnn.segmentation = [flatPoints];
                        const xs = ann.points.map(p => p.x);
                        const ys = ann.points.map(p => p.y);
                        const minX = Math.min(...xs), minY = Math.min(...ys);
                        const maxX = Math.max(...xs), maxY = Math.max(...ys);
                        cocoAnn.bbox = [minX, minY, maxX - minX, maxY - minY];
                        cocoAnn.area = (maxX - minX) * (maxY - minY);
                    }

                    coco.annotations.push(cocoAnn);
                });
            });

            const json = JSON.stringify(coco, null, 2);
            downloadFile(json, 'annotations_coco.json', 'application/json');
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ===========================================================================
        // PAN / DRAG SUPPORT
        // ===========================================================================
        let isPanMode = false;   // spacebar held
        let isPanning = false;   // actively dragging
        let panStartX = 0, panStartY = 0;
        let scrollStartX = 0, scrollStartY = 0;

        function enterPanMode() {
            if (isPanMode) return;
            isPanMode = true;
            canvas.classList.add('panning');
            document.getElementById('panIndicator').style.display = 'block';
        }

        function exitPanMode() {
            isPanMode = false;
            isPanning = false;
            canvas.classList.remove('panning', 'panning-active');
            document.getElementById('panIndicator').style.display = 'none';
        }

        // Spacebar hold for pan mode
        document.addEventListener('keydown', e => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            if (e.code === 'Space' && !e.repeat) {
                e.preventDefault();
                enterPanMode();
                return;
            }

            if (e.key === 'ArrowLeft') { navigateImage(-1); e.preventDefault(); }
            if (e.key === 'ArrowRight') { navigateImage(1); e.preventDefault(); }
            if (e.key === 'b' || e.key === 'B') selectTool('box');
            if (e.key === 'p' || e.key === 'P') selectTool('polygon');
            if (e.key === 't' || e.key === 'T') selectTool('point');
            if ((e.ctrlKey || e.metaKey) && e.key === 'z') { undoLast(); e.preventDefault(); }
            if (e.key === '+' || e.key === '=') { adjustZoom(0.1); e.preventDefault(); }
            if (e.key === '-') { adjustZoom(-0.1); e.preventDefault(); }
        });

        document.addEventListener('keyup', e => {
            if (e.code === 'Space') {
                e.preventDefault();
                exitPanMode();
            }
        });

        // Pan via mouse (spacebar+drag or middle-click drag)
        const wrapper = document.getElementById('canvasWrapper');

        canvas.addEventListener('mousedown', e => {
            // Middle mouse button (button 1) or spacebar held
            if (e.button === 1 || (isPanMode && e.button === 0)) {
                e.preventDefault();
                isPanning = true;
                panStartX = e.clientX;
                panStartY = e.clientY;
                scrollStartX = wrapper.scrollLeft;
                scrollStartY = wrapper.scrollTop;
                canvas.classList.add('panning-active');
            }
        }, true);

        window.addEventListener('mousemove', e => {
            if (!isPanning) return;
            e.preventDefault();
            const dx = e.clientX - panStartX;
            const dy = e.clientY - panStartY;
            wrapper.scrollLeft = scrollStartX - dx;
            wrapper.scrollTop = scrollStartY - dy;
        });

        window.addEventListener('mouseup', e => {
            if (isPanning) {
                isPanning = false;
                canvas.classList.remove('panning-active');
                if (!isPanMode) canvas.classList.remove('panning');
            }
        });

        // Prevent default middle-click paste/scroll behavior
        canvas.addEventListener('auxclick', e => { if (e.button === 1) e.preventDefault(); });

        // ===========================================================================
        // MOUSE WHEEL ZOOM (zoom towards cursor)
        // ===========================================================================
        wrapper.addEventListener('wheel', e => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.05 : 0.05;

            // Remember scroll position ratio before zoom
            const rect = wrapper.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            const ratioX = (wrapper.scrollLeft + mouseX) / wrapper.scrollWidth;
            const ratioY = (wrapper.scrollTop + mouseY) / wrapper.scrollHeight;

            adjustZoom(delta);

            // Adjust scroll to keep the point under the cursor stable
            requestAnimationFrame(() => {
                wrapper.scrollLeft = ratioX * wrapper.scrollWidth - mouseX;
                wrapper.scrollTop = ratioY * wrapper.scrollHeight - mouseY;
            });
        }, { passive: false });

    </script>
</body>

</html>